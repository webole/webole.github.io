<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Webole.GitHub.io by webole</title>
    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="javascripts/main.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

  </head>
  <body>

      <header>
        <h1>Webole.GitHub.io</h1>
        <p>Viva! Viva! Web Ole</p>
      </header>

      <div id="banner">
        <span id="logo"></span>

        <a href="https://github.com/webole" class="button fork"><strong>View On GitHub</strong></a>
      </div><!-- end banner -->

    <div class="wrapper">
      <nav>
        <ul></ul>
      </nav>
      <section>
        <h1>
<a id="setup-n-test" class="anchor" href="#setup-n-test" aria-hidden="true"><span class="octicon octicon-link"></span></a>setup n test</h1>

<h2>
<a id="clone-and-push-back" class="anchor" href="#clone-and-push-back" aria-hidden="true"><span class="octicon octicon-link"></span></a>clone and push back</h2>

<p>$ cd your_repo_root/repo_name
$ git fetch origin
$ git checkout gh-pages</p>

<h2>
<a id="in-general" class="anchor" href="#in-general" aria-hidden="true"><span class="octicon octicon-link"></span></a>In general</h2>

<p><code>s3_cache.py</code> maintains a cache, stored in an Amazon S3 (Simple Storage Service) bucket, of a given directory whose contents are considered non-critical and are completely &amp; solely determined by (and should be able to be regenerated from) a single given file.</p>

<p>The SHA-256 hash of the single file is used as the key for the cache. The directory is stored as a gzipped tarball.</p>

<p>All the tarballs are stored in S3's Reduced Redundancy Storage (RRS) storage class, since this is cheaper and the data is non-critical.</p>

<p><code>s3_cache.py</code> itself never deletes cache entries; deletion should either be done manually or using automatic S3 lifecycle rules on the bucket.</p>

<p>Similar to git, <code>s3_cache.py</code> makes the assumption that <a href="http://stackoverflow.com/questions/4014090/is-it-safe-to-ignore-the-possibility-of-sha-collisions-in-practice">SHA-256 will effectively never have a collision</a>.</p>

<h3>
<a id="for-bootstrap-specifically" class="anchor" href="#for-bootstrap-specifically" aria-hidden="true"><span class="octicon octicon-link"></span></a>For Bootstrap specifically</h3>

<p><code>s3_cache.py</code> is used to cache the npm packages that our Grunt tasks depend on and the RubyGems that Jekyll depends on. (Jekyll is needed to compile our docs to HTML so that we can run them thru an HTML5 validator.)</p>

<p>For npm, the <code>node_modules</code> directory is cached based on our <code>npm-shrinkwrap.canonical.json</code> file.</p>

<p>For RubyGems, the <code>gemdir</code> of the current RVM-selected Ruby is cached based on the <code>pseudo_Gemfile.lock</code> file generated by our Travis build script.
<code>pseudo_Gemfile.lock</code> contains the versions of Ruby and Jekyll that we're using (read our <code>.travis.yml</code> for details).</p>

<h2>
<a id="why-is-s3_cachepy-necessary" class="anchor" href="#why-is-s3_cachepy-necessary" aria-hidden="true"><span class="octicon octicon-link"></span></a>Why is <code>s3_cache.py</code> necessary?</h2>

<p><code>s3_cache.py</code> is used to speed up Bootstrap's Travis builds. Installing npm packages and RubyGems used to take up a significant fraction of our total build times. Also, at the time that <code>s3_cache.py</code> was written, npm was occasionally unreliable.</p>

<p>Travis does offer built-in caching on their paid plans, but this do-it-ourselves S3 solution is significantly cheaper since we only need caching and not Travis' other paid features.</p>

<h2>
<a id="setup" class="anchor" href="#setup" aria-hidden="true"><span class="octicon octicon-link"></span></a>Setup</h2>

<h3>
<a id="overview" class="anchor" href="#overview" aria-hidden="true"><span class="octicon octicon-link"></span></a>Overview</h3>

<ol>
<li>Create an Amazon Web Services (AWS) account.</li>
<li>Create an Identity &amp; Access Management (IAM) user, and note their credentials.</li>
<li>Create an S3 bucket.</li>
<li>Set permissions on the bucket to grant the user read+write access.</li>
<li>Set the user credentials as secure Travis environment variables.</li>
</ol>

<h3>
<a id="in-detail" class="anchor" href="#in-detail" aria-hidden="true"><span class="octicon octicon-link"></span></a>In detail</h3>

<ol>
<li>Create an AWS account.</li>
<li>Login to the <a href="https://console.aws.amazon.com">AWS Management Console</a>.</li>
<li>Go to the IAM Management Console.</li>
<li>Create a new user (named e.g. <code>travis-ci</code>) and generate an access key for them. Note both the Access Key ID and the Secret Access Key.</li>
<li>Note the user's ARN (Amazon Resource Name), which can be found in the "Summary" tab of the user browser. This will be of the form: <code>arn:aws:iam::XXXXXXXXXXXXXX:user/the-username-goes-here</code>
</li>
<li>Note the user's access key, which can be found in the "Security Credentials" tab of the user browser.</li>
<li>Go to the S3 Management Console.</li>
<li>
<p>Create a new bucket. For a non-publicly-accessible bucket (like Bootstrap uses), it's recommended that the bucket name be random to increase security. On most *nix machines, you can easily generate a random UUID to use as the bucket name using Python:</p>

<div class="highlight highlight-bash"><pre>python -c <span class="pl-s1"><span class="pl-pds">"</span>import uuid; print(uuid.uuid4())<span class="pl-pds">"</span></span></pre></div>
</li>
<li><p>Determine and note what your bucket's ARN is. The ARN for an S3 bucket is of the form: <code>arn:aws:s3:::the-bucket-name-goes-here</code></p></li>
<li>In the bucket's Properties pane, in the "Permissions" section, click the "Edit bucket policy" button.</li>
<li>
<p>Input and submit an IAM Policy that grants the user at least read+write rights to the bucket. AWS has a policy generator and some examples to help with crafting the policy. Here's the policy that Bootstrap uses, with the sensitive bits censored:</p>

<div class="highlight highlight-json"><pre>{
    <span class="pl-s1"><span class="pl-pds">"</span>Version<span class="pl-pds">"</span></span>: <span class="pl-s1"><span class="pl-pds">"</span>2012-10-17<span class="pl-pds">"</span></span>,
    <span class="pl-s1"><span class="pl-pds">"</span>Id<span class="pl-pds">"</span></span>: <span class="pl-s1"><span class="pl-pds">"</span>PolicyTravisReadWriteNoAdmin<span class="pl-pds">"</span></span>,
    <span class="pl-s1"><span class="pl-pds">"</span>Statement<span class="pl-pds">"</span></span>: [
        {
            <span class="pl-s1"><span class="pl-pds">"</span>Sid<span class="pl-pds">"</span></span>: <span class="pl-s1"><span class="pl-pds">"</span>StmtXXXXXXXXXXXXXX<span class="pl-pds">"</span></span>,
            <span class="pl-s1"><span class="pl-pds">"</span>Effect<span class="pl-pds">"</span></span>: <span class="pl-s1"><span class="pl-pds">"</span>Allow<span class="pl-pds">"</span></span>,
            <span class="pl-s1"><span class="pl-pds">"</span>Principal<span class="pl-pds">"</span></span>: {
                <span class="pl-s1"><span class="pl-pds">"</span>AWS<span class="pl-pds">"</span></span>: <span class="pl-s1"><span class="pl-pds">"</span>arn:aws:iam::XXXXXXXXXXXXXX:user/travis-ci<span class="pl-pds">"</span></span>
            },
            <span class="pl-s1"><span class="pl-pds">"</span>Action<span class="pl-pds">"</span></span>: [
                <span class="pl-s1"><span class="pl-pds">"</span>s3:AbortMultipartUpload<span class="pl-pds">"</span></span>,
                <span class="pl-s1"><span class="pl-pds">"</span>s3:GetObjectVersion<span class="pl-pds">"</span></span>,
                <span class="pl-s1"><span class="pl-pds">"</span>s3:ListBucket<span class="pl-pds">"</span></span>,
                <span class="pl-s1"><span class="pl-pds">"</span>s3:DeleteObject<span class="pl-pds">"</span></span>,
                <span class="pl-s1"><span class="pl-pds">"</span>s3:DeleteObjectVersion<span class="pl-pds">"</span></span>,
                <span class="pl-s1"><span class="pl-pds">"</span>s3:GetObject<span class="pl-pds">"</span></span>,
                <span class="pl-s1"><span class="pl-pds">"</span>s3:PutObject<span class="pl-pds">"</span></span>
            ],
            <span class="pl-s1"><span class="pl-pds">"</span>Resource<span class="pl-pds">"</span></span>: [
                <span class="pl-s1"><span class="pl-pds">"</span>arn:aws:s3:::XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX<span class="pl-pds">"</span></span>,
                <span class="pl-s1"><span class="pl-pds">"</span>arn:aws:s3:::XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX/*<span class="pl-pds">"</span></span>
            ]
        }
    ]
}</pre></div>
</li>
<li><p>If you want deletion from the cache to be done automatically based on age (like Bootstrap does): In the bucket's Properties pane, in the "Lifecycle" section, add a rule to expire/delete files based on creation date.</p></li>
<li>Install the <a href="https://github.com/travis-ci/travis"><code>travis</code> RubyGem</a>: <code>gem install travis</code>
</li>
<li>
<p>Encrypt the environment variables:</p>

<div class="highlight highlight-bash"><pre>travis encrypt --repo twbs/bootstrap <span class="pl-s1"><span class="pl-pds">"</span>AWS_ACCESS_KEY_ID=XXX<span class="pl-pds">"</span></span>
travis encrypt --repo twbs/bootstrap <span class="pl-s1"><span class="pl-pds">"</span>AWS_SECRET_ACCESS_KEY=XXX<span class="pl-pds">"</span></span>
travis encrypt --repo twbs/bootstrap <span class="pl-s1"><span class="pl-pds">"</span>TWBS_S3_BUCKET=XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX<span class="pl-pds">"</span></span></pre></div>
</li>
<li><p>Add the resulting secure environment variables to <code>.travis.yml</code>.</p></li>
</ol>

<h2>
<a id="usage" class="anchor" href="#usage" aria-hidden="true"><span class="octicon octicon-link"></span></a>Usage</h2>

<p>Read <code>s3_cache.py</code>'s source code and Bootstrap's <code>.travis.yml</code> for how to invoke and make use of <code>s3_cache.py</code>.</p>
      </section>
      <footer>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://twitter.com/michigangraham">mattgraham</a></small></p>
      </footer>
    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
    
  </body>
</html>